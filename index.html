<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surtido Maestro - Blaebuck Files</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: bold; }
        #reader, #reader-db { width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-top: 10px; display: none; min-height: 250px; }
        .modal-overlay { background: rgba(0,0,0,0.8); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 60; max-height: 300px; overflow-y: auto; border-radius: 8px; margin-top: 5px; border: 1px solid #e5e7eb; }
        .dropdown-content button { width: 100%; text-align: left; padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 11px; text-transform: uppercase; font-weight: bold; }
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 1000; flex-direction: column; align-items:center; justify-content:center; }
    </style>
</head>
<body class="p-4">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-2"></div>
        <span class="text-[10px] font-black text-blue-900">SINCRONIZANDO...</span>
    </div>

    <div id="modalConfirmar" class="modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-900">
            <div id="modalHeader" class="bg-blue-900 p-4 text-white flex justify-between items-center">
                <h3 class="font-black uppercase text-xs italic">Detalle de Producto</h3>
                <span id="modalPrecioTag" class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold"></span>
            </div>
            <div class="p-5">
                <div id="modalFicha" class="mb-4 border-b pb-4 text-sm font-bold text-blue-900 uppercase"></div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Empaque</label>
                        <select id="modalTipoCaja" onchange="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-blue-700">
                            <option value="0">Unidades x 1</option>
                            <option value="6">Caja x 6</option>
                            <option value="12">Caja x 12</option>
                            <option value="24">Caja x 24</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Cantidad</label>
                        <input id="modalCantCajas" type="number" oninput="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-center text-blue-600" value="0">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-orange-500 uppercase">Total Unidades</label>
                    <input id="modalUnidadesFinal" type="number" class="w-full p-3 border-2 border-orange-200 rounded-lg font-black text-center text-xl text-orange-600" value="0">
                </div>
                <div class="flex gap-2">
                    <button onclick="cerrarModal()" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold uppercase text-[10px]">Cerrar</button>
                    <button id="btnAccionModal" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-[10px]">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto">
        <div class="flex justify-around mb-4 bg-white rounded-lg p-2 shadow-sm sticky top-0 z-50">
            <button onclick="switchTab('surtido')" id="btn-surtido" class="tab-active py-2 px-4 text-sm uppercase">Surtido</button>
            <button onclick="switchTab('precios')" id="btn-precios" class="py-2 px-4 text-gray-500 text-sm uppercase">Catálogo</button>
            <button onclick="switchTab('historial')" id="btn-historial" class="py-2 px-4 text-gray-500 text-sm uppercase">Historial</button>
        </div>

        <div id="tab-surtido">
            <div class="card p-4 mb-4 border border-blue-100 grid grid-cols-2 gap-2">
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Surtidor</label><input id="nombreSurtidor" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()" placeholder="Nombre"></div>
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Almacén</label><input id="nombreAlmacen" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()" placeholder="Bodega"></div>
            </div>
            
            <button onclick="toggleScanner('surtido')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold uppercase text-xs mb-4 shadow-md">[ CÁMARA ESCÁNER ]</button>
            <div id="reader" class="mb-4"></div>

            <div class="card p-5 mb-6 relative">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[9px] font-black text-blue-900 uppercase italic">Buscador Maestro</label>
                    <button onclick="sincronizarConNube()" class="text-blue-600 font-black text-[10px] uppercase italic">ACTUALIZAR NUBE</button>
                </div>
                
                <div class="flex gap-1">
                    <button onclick="resetSurtidoInputs()" class="bg-gray-200 px-4 rounded-lg font-bold" title="Limpiar">LIMPIAR</button>
                    <input id="ref" type="text" placeholder="REF / PLU / EAN" oninput="busquedaDinamica()" class="flex-1 p-3 rounded-lg bg-blue-50 font-bold border border-blue-100 uppercase">
                    <button onclick="forzarBusquedaLupa()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">BUSCAR</button>
                </div>
            </div>

            <div class="card overflow-hidden mb-4">
                <div class="bg-gray-800 text-white p-2 flex justify-between items-center text-[8px] uppercase font-bold">
                    <span>LISTADO DE SURTIDO</span>
                    <button onclick="vaciarTodo()" class="bg-red-700 px-2 py-1 rounded italic text-[7px]">BARRER TODO</button>
                </div>
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-[8px]">
                        <tr><th class="p-2">ARTÍCULO</th><th class="p-2 text-center">CAJ</th><th class="p-2 text-center">U.TOT</th><th class="p-2"></th></tr>
                    </thead>
                    <tbody id="listaSurtido" class="divide-y divide-gray-100"></tbody>
                    <tfoot class="bg-blue-900 text-white font-black italic">
                        <tr><td colspan="2" class="p-3 text-right text-[10px]">TOTAL ACUMULADO:</td><td id="granTotal" class="p-3 text-center text-lg">0</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="card p-4 mb-10">
                <input id="fechaPicking" type="date" class="w-full p-2 border rounded font-bold text-blue-900 mb-2">
                <button onclick="finalizarDia()" class="w-full p-3 bg-green-600 text-white rounded-lg text-[11px] font-bold uppercase">GUARDAR EN HISTORIAL</button>
            </div>
        </div>

        <div id="tab-precios" class="hidden">
            <button onclick="toggleScanner('catalogo')" class="w-full bg-green-700 text-white py-3 rounded-lg font-bold uppercase text-xs mb-4 shadow-md">[ ESCANEAR PARA EDITAR ]</button>
            <div id="reader-db" class="mb-4"></div>
            
            <div class="card p-4 mb-4 bg-green-50">
                <h3 class="font-black text-green-800 text-[10px] uppercase italic mb-3">Editor de Productos</h3>
                <div class="grid grid-cols-1 gap-2">
                    <input id="db-ref" type="text" placeholder="Código / EAN" class="p-2 rounded border font-bold uppercase">
                    <input id="db-desc" type="text" placeholder="Nombre del Producto" class="p-2 rounded border uppercase font-bold">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="db-gr" type="text" placeholder="Gramos/Peso" class="p-2 rounded border font-bold">
                        <input id="db-plu" type="text" placeholder="PLU" class="p-2 rounded border font-bold">
                    </div>
                    <input id="db-marca" type="text" placeholder="Marca" class="p-2 rounded border uppercase font-bold">
                    <input id="db-precio" type="number" placeholder="Precio $" class="p-2 rounded border font-bold text-green-700">
                    <button onclick="guardarEnCatalogo()" class="bg-green-700 text-white p-3 rounded font-bold uppercase text-[10px]">GUARDAR PRODUCTO</button>
                </div>
            </div>
            <div id="db-lista" class="card p-2 divide-y divide-gray-100 text-[10px] max-h-60 overflow-y-auto"></div>
        </div>

        <div id="tab-historial" class="hidden">
            <div id="listaHistorial" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // RECUERDE PONER SU LINK AQUÍ
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbxNj_qkhubhEUJHZtOZOzI23iTxnxBwzfjlBmneNAdmCb0YcKd3RL6xWZ3Ei1B9UgW5Cg/exec";

        let registros = JSON.parse(localStorage.getItem('surtido_v21_final')) || [];
        let catalogo = JSON.parse(localStorage.getItem('catalogo_db')) || {};
        let historial = JSON.parse(localStorage.getItem('historial_picking_v2')) || [];
        let perfil = JSON.parse(localStorage.getItem('perfil_blaebuck')) || { surtidor: '', almacen: '' };
        
        let html5QrCode = null;
        let pEscaneado = null;

        // --- FUNCIONES CORE ---
        async function sincronizarConNube() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const response = await fetch(URL_GOOGLE + "?action=getCatalog");
                const data = await response.json();
                if (data) {
                    catalogo = data;
                    localStorage.setItem('catalogo_db', JSON.stringify(catalogo));
                    renderizarCatalogo();
                    alert("¡Sincronización Exitosa!");
                }
            } catch (e) { alert("Error al conectar con la nube."); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function busquedaDinamica() {
            const v = document.getElementById('ref').value.trim();
            if (v.length >= 4) {
                let e = Object.keys(catalogo).find(k => k === v || k.endsWith(v));
                if (e) { 
                    pEscaneado = { ref: e, ...catalogo[e] }; 
                    abrirFicha(); 
                    document.getElementById('ref').value = ""; 
                }
            }
        }

        function forzarBusquedaLupa() {
            const v = document.getElementById('ref').value.trim();
            let e = Object.keys(catalogo).find(k => k === v || k.endsWith(v) || (catalogo[k] && catalogo[k].plu === v));
            if (e) { pEscaneado = { ref: e, ...catalogo[e] }; abrirFicha(); }
            else { alert("Producto no encontrado en catálogo."); }
        }

        function abrirFicha() {
            document.getElementById('modalPrecioTag').innerText = "$" + (pEscaneado.precio || 0);
            document.getElementById('modalFicha').innerHTML = `
                <div class="text-lg font-black text-blue-900">${pEscaneado.desc}</div>
                <div class="text-xs text-blue-500">${pEscaneado.marca} | PLU: ${pEscaneado.plu}</div>
            `;
            document.getElementById('modalConfirmar').style.display = 'flex';
        }

        function guardarPicking() {
            const cant = parseInt(document.getElementById('modalUnidadesFinal').value) || 0;
            if(cant <= 0) return alert("Ingrese una cantidad");

            registros.push({
                desc: pEscaneado.desc,
                ref: pEscaneado.ref,
                totalCajas: document.getElementById('modalCantCajas').value,
                unidadesDeCajas: cant
            });

            // Enviar a la nube automáticamente
            fetch(URL_GOOGLE, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    surtidor: document.getElementById('nombreSurtidor').value,
                    almacen: document.getElementById('nombreAlmacen').value,
                    producto: pEscaneado.desc,
                    plu: pEscaneado.plu,
                    cantidad: cant
                })
            });

            renderizar();
            cerrarModal();
        }

        function renderizar() {
            const lista = document.getElementById('listaSurtido');
            lista.innerHTML = '';
            let total = 0;
            registros.forEach((item, i) => {
                total += item.unidadesDeCajas;
                lista.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2 font-bold">${item.desc}</td>
                        <td class="p-2 text-center text-gray-500">${item.totalCajas}</td>
                        <td class="p-2 text-center font-black text-blue-700">${item.unidadesDeCajas}</td>
                        <td class="p-2"><button onclick="borrarItem(${i})">X</button></td>
                    </tr>`;
            });
            document.getElementById('granTotal').innerText = total;
            localStorage.setItem('surtido_v21_final', JSON.stringify(registros));
        }

        function guardarEnCatalogo() {
            const r = document.getElementById('db-ref').value;
            catalogo[r] = {
                desc: document.getElementById('db-desc').value.toUpperCase(),
                gr: document.getElementById('db-gr').value,
                plu: document.getElementById('db-plu').value,
                marca: document.getElementById('db-marca').value.toUpperCase(),
                precio: document.getElementById('db-precio').value
            };
            localStorage.setItem('catalogo_db', JSON.stringify(catalogo));
            
            fetch(URL_GOOGLE, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ tipo: 'catalogo', ref: r, ...catalogo[r] })
            });
            
            alert("Producto guardado en Nube y Local");
            renderizarCatalogo();
            resetDBInputs();
        }

        // --- UTILIDADES ---
        function switchTab(t) {
            detenerEscaner();
            document.getElementById('tab-surtido').classList.toggle('hidden', t !== 'surtido');
            document.getElementById('tab-precios').classList.toggle('hidden', t !== 'precios');
            document.getElementById('tab-historial').classList.toggle('hidden', t !== 'historial');
        }

        function recalcularUnidadesModal() {
            const factor = parseInt(document.getElementById('modalTipoCaja').value) || 1;
            const cant = parseInt(document.getElementById('modalCantCajas').value) || 0;
            document.getElementById('modalUnidadesFinal').value = factor === 0 ? cant : cant * factor;
        }

        function cerrarModal() { document.getElementById('modalConfirmar').style.display = 'none'; }
        function resetSurtidoInputs() { document.getElementById('ref').value = ""; }
        function resetDBInputs() { ['db-ref','db-desc','db-gr','db-plu','db-marca','db-precio'].forEach(id => document.getElementById(id).value = ""); }
        function borrarItem(i) { registros.splice(i, 1); renderizar(); }
        function vaciarTodo() { if(confirm("¿Borrar todo el listado?")) { registros = []; renderizar(); } }

        async function detenerEscaner() { if(html5QrCode) { await html5QrCode.stop(); html5QrCode = null; } document.getElementById('reader').style.display='none'; document.getElementById('reader-db').style.display='none'; }
        
        async function toggleScanner(tipo) {
            const id = tipo === 'surtido' ? 'reader' : 'reader-db';
            if(document.getElementById(id).style.display === 'none') {
                document.getElementById(id).style.display = 'block';
                html5QrCode = new Html5Qrcode(id);
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                    if(tipo === 'surtido') { document.getElementById('ref').value = text; busquedaDinamica(); }
                    else { document.getElementById('db-ref').value = text; }
                    detenerEscaner();
                });
            } else { detenerEscaner(); }
        }

        function guardarPerfil() {
            perfil.surtidor = document.getElementById('nombreSurtidor').value;
            perfil.almacen = document.getElementById('nombreAlmacen').value;
            localStorage.setItem('perfil_blaebuck', JSON.stringify(perfil));
        }

        window.onload = () => {
            document.getElementById('nombreSurtidor').value = perfil.surtidor;
            document.getElementById('nombreAlmacen').value = perfil.almacen;
            document.getElementById('fechaPicking').value = new Date().toISOString().split('T')[0];
            renderizar();
        };
    </script>
</body>
</html>
