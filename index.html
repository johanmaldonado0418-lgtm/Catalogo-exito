<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surtido Maestro - Blaebuck Files v35.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: bold; }
        #reader, #reader-db { width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-top: 10px; display: none; min-height: 250px; }
        .modal-overlay { background: rgba(0,0,0,0.8); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 1000; flex-direction: column; align-items:center; justify-content:center; }
    </style>
</head>
<body class="p-4">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-2"></div>
        <span class="text-[10px] font-black text-blue-900">PROCESANDO...</span>
    </div>

    <div id="modalConfirmar" class="modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-900">
            <div class="bg-blue-900 p-4 text-white flex justify-between items-center">
                <h3 class="font-black uppercase text-xs italic">Agregar Producto</h3>
                <span id="modalPrecioTag" class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold"></span>
            </div>
            <div class="p-5">
                <div id="modalFicha" class="mb-4 border-b pb-4 text-sm font-bold text-blue-900 uppercase"></div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Empaque</label>
                        <select id="modalTipoCaja" onchange="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-blue-700">
                            <option value="0">Unidades</option><option value="1">Caja x 1</option><option value="6">Caja x 6</option><option value="12">Caja x 12</option><option value="24">Caja x 24</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Cantidad</label>
                        <input id="modalCantCajas" type="number" oninput="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-center text-blue-600" value="0">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-orange-500 uppercase italic">Unidades a Cargar</label>
                    <input id="modalUnidadesFinal" type="number" class="w-full p-3 border-2 border-orange-200 rounded-lg font-black text-center text-xl text-orange-600" value="0">
                </div>
                <div class="flex gap-2">
                    <button onclick="cerrarModal()" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-[10px]">CERRAR</button>
                    <button id="btnAccionModal" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-[10px]">CONFIRMAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto">
        <div class="flex justify-around mb-4 bg-white rounded-lg p-2 shadow-sm sticky top-0 z-50">
            <button onclick="switchTab('surtido')" id="btn-surtido" class="tab-active py-2 px-4 text-xs uppercase">Surtido</button>
            <button onclick="switchTab('precios')" id="btn-precios" class="py-2 px-4 text-gray-500 text-xs uppercase">Cat√°logo</button>
            <button onclick="switchTab('historial')" id="btn-historial" class="py-2 px-4 text-gray-500 text-xs uppercase">Historial</button>
        </div>

        <div id="tab-surtido">
            <div class="card p-4 mb-4 border border-blue-100 grid grid-cols-2 gap-2">
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Surtidor</label><input id="nombreSurtidor" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()"></div>
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Almac√©n</label><input id="nombreAlmacen" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()"></div>
            </div>
            
            <div class="card p-4 mb-4">
                <button onclick="toggleScanner('surtido')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold uppercase text-xs">üì∏ Abrir C√°mara</button>
                <div id="reader"></div>
            </div>

            <div class="card p-4 mb-4">
                <div class="flex gap-1">
                    <input id="ref" type="text" placeholder="C√ìDIGO O PLU" class="flex-1 p-2 rounded-lg bg-blue-50 font-bold border border-blue-100 uppercase">
                    <button onclick="forzarBusquedaLupa()" class="bg-blue-600 text-white px-4 rounded-lg">üîé</button>
                </div>
            </div>

            <div class="card overflow-hidden mb-4">
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-gray-800 text-white text-[8px] uppercase">
                        <tr><th class="p-2">Art√≠culo</th><th class="p-2 text-center">Cant</th><th class="p-2 text-center">Total</th><th class="p-2"></th></tr>
                    </thead>
                    <tbody id="listaSurtido" class="divide-y divide-gray-100"></tbody>
                    <tfoot class="bg-blue-900 text-white font-black">
                        <tr><td colspan="2" class="p-3 text-right">TOTAL:</td><td id="granTotal" class="p-3 text-center text-lg">0</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="card p-4 mb-10 border border-green-200">
                <input id="fechaPicking" type="date" class="w-full p-2 border rounded font-bold mb-2">
                <button onclick="finalizarDia()" class="w-full p-3 bg-green-600 text-white rounded-lg font-bold uppercase shadow-lg">üíæ GUARDAR REPORTE DEFINITIVO</button>
            </div>
        </div>

        <div id="tab-precios" class="hidden">
            <div class="card p-4 mb-4 bg-green-50 border border-green-200">
                <h3 class="font-black text-green-800 text-[10px] uppercase mb-2">Nuevo Producto</h3>
                <div class="grid grid-cols-1 gap-2">
                    <input id="db-ref" type="text" placeholder="C√ìDIGO DE BARRAS" class="p-2 rounded border font-bold uppercase">
                    <input id="db-desc" type="text" placeholder="DESCRIPCI√ìN" class="p-2 rounded border uppercase font-bold">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="db-plu" type="text" placeholder="PLU" class="p-2 rounded border font-bold">
                        <input id="db-marca" type="text" placeholder="MARCA" class="p-2 rounded border uppercase font-bold">
                    </div>
                    <input id="db-precio" type="number" placeholder="PRECIO $" class="p-2 rounded border font-bold">
                    <button onclick="guardarEnCatalogo()" class="bg-green-700 text-white p-3 rounded font-bold uppercase">REGISTRAR</button>
                </div>
            </div>
            <div id="db-lista" class="card p-2 text-[10px] max-h-60 overflow-y-auto"></div>
        </div>

        <div id="tab-historial" class="hidden">
            <div class="card p-4 bg-blue-50">
                <h2 class="font-black text-blue-900 text-[10px] uppercase mb-3">Historial de Reportes</h2>
                <div id="listaHistorial" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbxNj_qkhubhEUJHZtOZOzI23iTxnxBwzfjlBmneNAdmCb0YcKd3RL6xWZ3Ei1B9UgW5Cg/exec";

        let registros = JSON.parse(localStorage.getItem('surtido_v21_final')) || [];
        let catalogo = JSON.parse(localStorage.getItem('catalogo_db')) || {};
        let historial = JSON.parse(localStorage.getItem('historial_picking_v2')) || [];
        let perfil = JSON.parse(localStorage.getItem('perfil_blaebuck')) || { surtidor: '', almacen: '' };
        
        let html5QrCode = null; 
        let pEscaneado = null;

        function switchTab(t) {
            detenerEscaner();
            document.getElementById('tab-surtido').classList.toggle('hidden', t !== 'surtido');
            document.getElementById('tab-precios').classList.toggle('hidden', t !== 'precios');
            document.getElementById('tab-historial').classList.toggle('hidden', t !== 'historial');
            if(t === 'historial') renderizarHistorial();
        }

        function forzarBusquedaLupa() {
            const v = document.getElementById('ref').value.trim();
            let e = Object.keys(catalogo).find(k => k === v || k.endsWith(v) || (catalogo[k] && catalogo[k].plu === v));
            if (e) { pEscaneado = { ref: e, ...catalogo[e] }; abrirFicha(); }
            else { alert("Producto no existe."); }
        }

        function abrirFicha() {
            document.getElementById('modalPrecioTag').innerText = pEscaneado.precio + " $";
            document.getElementById('modalFicha').innerHTML = `<b>${pEscaneado.desc}</b><br><span class="text-xs">PLU: ${pEscaneado.plu}</span>`;
            document.getElementById('modalConfirmar').style.display = 'flex';
            document.getElementById('btnAccionModal').onclick = guardarPicking;
        }

        function guardarPicking() { 
            const u = parseInt(document.getElementById('modalUnidadesFinal').value) || 0; 
            if(u <= 0) return alert("Cantidad inv√°lida");
            registros.push({ ...pEscaneado, unidadesDeCajas: u }); 
            renderizar(); cerrarModal(); 
            // Env√≠o silencioso a Google
            fetch(`${URL_GOOGLE}?surtidor=${perfil.surtidor}&almacen=${perfil.almacen}&producto=${pEscaneado.desc}&cantidad=${u}`, {mode:'no-cors'});
        }

        function renderizar() { 
            const l = document.getElementById('listaSurtido'); l.innerHTML = ''; let t = 0; 
            registros.forEach((item, i) => { 
                t += item.unidadesDeCajas; 
                l.innerHTML += `<tr class="border-b"><td class="p-2"><b>${item.desc}</b></td><td class="p-2 text-center">${item.unidadesDeCajas}</td><td class="p-2 text-center font-bold">${item.unidadesDeCajas}</td><td class="p-2"><button onclick="borrarItem(${i})">‚ùå</button></td></tr>`; 
            }); 
            document.getElementById('granTotal').innerText = t; 
            localStorage.setItem('surtido_v21_final', JSON.stringify(registros)); 
        }

        // ARREGLO PARA GUARDAR EL REPORTE
        function finalizarDia() {
            const surtidor = document.getElementById('nombreSurtidor').value.trim();
            const almacen = document.getElementById('nombreAlmacen').value.trim();
            const fecha = document.getElementById('fechaPicking').value;

            if(!surtidor || !almacen) return alert("Escribe tu NOMBRE y el ALMAC√âN antes de guardar.");
            if(registros.length === 0) return alert("La lista est√° vac√≠a.");

            // Guardar en el array de historial
            const nuevoReporte = {
                fecha: fecha,
                surtidor: surtidor,
                almacen: almacen,
                total: document.getElementById('granTotal').innerText,
                items: [...registros]
            };

            historial.unshift(nuevoReporte);
            localStorage.setItem('historial_picking_v2', JSON.stringify(historial));
            
            // Limpiar lista actual
            registros = [];
            renderizar();
            
            alert("‚úÖ REPORTE GUARDADO CON √âXITO. Revisa la pesta√±a Historial.");
            switchTab('historial');
        }

        function renderizarHistorial() { 
            const l = document.getElementById('listaHistorial'); l.innerHTML = ''; 
            if(historial.length === 0) l.innerHTML = '<p class="text-center text-gray-400 text-xs">No hay reportes guardados.</p>';
            historial.forEach((h, i) => { 
                l.innerHTML += `<div class="p-3 bg-white rounded-lg shadow-sm flex justify-between items-center border-l-4 border-blue-900">
                    <div class="text-[10px]"><b>${h.fecha}</b> - ${h.almacen}<br>Total: ${h.total} unidades</div>
                    <button onclick="descargarReporte(${i})" class="bg-blue-100 text-blue-700 px-3 py-1 rounded font-bold text-[10px]">VER PDF</button>
                </div>`; 
            }); 
        }

        function descargarReporte(idx) {
            const h = historial[idx];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("REPORTE DE SURTIDO - BLAEBUCK FILES", 10, 20);
            doc.setFontSize(10);
            doc.text(`Surtidor: ${h.surtidor} | Almac√©n: ${h.almacen} | Fecha: ${h.fecha}`, 10, 30);
            doc.autoTable({
                startY: 40,
                head: [['Producto', 'PLU', 'Cantidad']],
                body: h.items.map(it => [it.desc, it.plu, it.unidadesDeCajas])
            });
            doc.save(`Reporte_${h.almacen}_${h.fecha}.pdf`);
        }

        function guardarEnCatalogo() { 
            const r = document.getElementById('db-ref').value.trim();
            if(!r) return alert("Falta el c√≥digo");
            catalogo[r] = { 
                desc: document.getElementById('db-desc').value.toUpperCase(), 
                plu: document.getElementById('db-plu').value, 
                marca: document.getElementById('db-marca').value.toUpperCase(), 
                precio: document.getElementById('db-precio').value 
            }; 
            localStorage.setItem('catalogo_db', JSON.stringify(catalogo)); 
            renderizarCatalogo(); alert("Guardado.");
        }

        function renderizarCatalogo() { 
            const l = document.getElementById('db-lista'); l.innerHTML = ''; 
            for(let r in catalogo) { l.innerHTML += `<div class="p-1 border-b uppercase">${catalogo[r].desc} [${r}]</div>`; } 
        }

        async function detenerEscaner() { if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} html5QrCode = null; } document.getElementById('reader').style.display='none'; }
        async function toggleScanner(tipo) { 
            await detenerEscaner();
            document.getElementById('reader').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                document.getElementById('ref').value = text;
                forzarBusquedaLupa();
                detenerEscaner();
            });
        }

        function recalcularUnidadesModal() { 
            const f = parseInt(document.getElementById('modalTipoCaja').value); 
            const c = parseInt(document.getElementById('modalCantCajas').value) || 0; 
            document.getElementById('modalUnidadesFinal').value = (f === 0 ? c : c * f); 
        }
        function cerrarModal() { document.getElementById('modalConfirmar').style.display = 'none'; }
        function borrarItem(i) { registros.splice(i,1); renderizar(); }
        function guardarPerfil() { 
            perfil.surtidor = document.getElementById('nombreSurtidor').value; 
            perfil.almacen = document.getElementById('nombreAlmacen').value; 
            localStorage.setItem('perfil_blaebuck', JSON.stringify(perfil)); 
        }

        window.onload = () => { 
            document.getElementById('fechaPicking').value = new Date().toISOString().split('T')[0];
            document.getElementById('nombreSurtidor').value = perfil.surtidor || '';
            document.getElementById('nombreAlmacen').value = perfil.almacen || '';
            renderizar(); renderizarCatalogo(); 
        };
    </script>
</body>
</html>
